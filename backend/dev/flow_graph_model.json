{
  "revision": 4,
  "updated_at": "2026-02-13T14:01:01.258044+00:00",
  "updated_by": "smoke-rollback",
  "model": {
    "meta": {
      "title": "REG-01 Runtime Flow",
      "description": "Editable runtime graph model for dev console"
    },
    "nodes": [
      {
        "id": "ingress",
        "title": "Ingress Router",
        "group": "io",
        "description": "Receive inbound message from web or webhook route.",
        "file_refs": [
          "backend/router/chat_router.py",
          "backend/router/webhook_router.py",
          "backend/main.py"
        ],
        "lane": 0,
        "order": 0,
        "enabled": true,
        "badges": [
          "web",
          "facebook"
        ]
      },
      {
        "id": "stt",
        "title": "Speech-to-Text",
        "group": "io",
        "description": "Transcribe audio input before entering LLM pipeline.",
        "file_refs": [
          "backend/app/stt.py",
          "backend/router/chat_router.py"
        ],
        "lane": 1,
        "order": 0,
        "enabled": true,
        "badges": [
          "conditional: audio"
        ]
      },
      {
        "id": "session",
        "title": "Session + Memory",
        "group": "memory",
        "description": "Load and persist conversation history and summary.",
        "file_refs": [
          "backend/memory/session.py",
          "backend/memory/session_db.py",
          "backend/memory/memory.py"
        ],
        "lane": 1,
        "order": 1,
        "enabled": true,
        "badges": [
          "summary=on",
          "recent=10"
        ]
      },
      {
        "id": "prompt",
        "title": "Prompt Builder",
        "group": "prompt",
        "description": "Build prompt with context, summary, and recent history.",
        "file_refs": [
          "backend/app/utils/llm/llm.py",
          "backend/app/prompt/prompt.py",
          "backend/app/prompt/request_prompt.py"
        ],
        "lane": 2,
        "order": 1,
        "enabled": true,
        "badges": [
          "lang-detect"
        ]
      },
      {
        "id": "llm_primary",
        "title": "LLM Call #1",
        "group": "llm",
        "description": "Initial response or route decision for RAG.",
        "file_refs": [
          "backend/app/utils/llm/llm.py",
          "backend/app/utils/llm/llm_model.py"
        ],
        "lane": 3,
        "order": 1,
        "enabled": true,
        "badges": [
          "primary"
        ]
      },
      {
        "id": "rag_gate",
        "title": "RAG Decision Gate",
        "group": "routing",
        "description": "Route by rag.mode: keyword, always, never.",
        "file_refs": [
          "backend/app/utils/llm/llm.py",
          "backend/dev/flow_store.py"
        ],
        "lane": 4,
        "order": 1,
        "enabled": true,
        "badges": [
          "mode=keyword",
          "top_k=5"
        ]
      },
      {
        "id": "retriever",
        "title": "Hybrid Retriever",
        "group": "retrieval",
        "description": "Search context from vector/BM25 with rerank options.",
        "file_refs": [
          "backend/retriever/context_selector.py",
          "backend/retriever/hybrid_retriever.py",
          "backend/app/utils/vector_manager.py"
        ],
        "lane": 5,
        "order": 0,
        "enabled": true,
        "badges": [
          "hybrid=on",
          "rerank=on",
          "intent=on"
        ]
      },
      {
        "id": "llm_rag",
        "title": "LLM Call #2 (RAG)",
        "group": "llm",
        "description": "Create final answer from retrieved context.",
        "file_refs": [
          "backend/app/utils/llm/llm.py"
        ],
        "lane": 6,
        "order": 0,
        "enabled": true,
        "badges": [
          "secondary"
        ]
      },
      {
        "id": "faq_learn",
        "title": "FAQ Auto Learn",
        "group": "memory",
        "description": "Update FAQ cache automatically for qualified answers.",
        "file_refs": [
          "backend/memory/faq_cache.py",
          "backend/app/utils/llm/llm.py"
        ],
        "lane": 6,
        "order": 1,
        "enabled": true,
        "badges": [
          "auto_learn=on"
        ]
      },
      {
        "id": "answer_post",
        "title": "Answer Post-Process",
        "group": "post",
        "description": "Merge direct answer path and RAG answer path.",
        "file_refs": [
          "backend/app/utils/llm/llm.py",
          "backend/router/chat_router.py",
          "backend/router/background_tasks.py"
        ],
        "lane": 6,
        "order": 2,
        "enabled": true,
        "badges": [
          "merge"
        ]
      },
      {
        "id": "pose",
        "title": "Pose Suggestion",
        "group": "post",
        "description": "Infer animation pose from response text.",
        "file_refs": [
          "backend/app/utils/pose.py",
          "backend/router/chat_router.py"
        ],
        "lane": 7,
        "order": 1,
        "enabled": true,
        "badges": [
          "enabled=on"
        ]
      },
      {
        "id": "output",
        "title": "Output Emit + TTS + Logs",
        "group": "io",
        "description": "Emit final result, stream TTS, and write audit logs.",
        "file_refs": [
          "backend/router/chat_router.py",
          "backend/main.py",
          "backend/app/tts.py"
        ],
        "lane": 8,
        "order": 1,
        "enabled": true,
        "badges": [
          "socketio",
          "tts",
          "audit"
        ]
      }
    ],
    "edges": [
      {
        "id": "e_ingress_stt",
        "source": "ingress",
        "target": "stt",
        "label": "if audio",
        "enabled": true,
        "conditional": true
      },
      {
        "id": "e_ingress_session",
        "source": "ingress",
        "target": "session",
        "label": "text/session_id",
        "enabled": true,
        "conditional": false
      },
      {
        "id": "e_stt_session",
        "source": "stt",
        "target": "session",
        "label": "transcribed text",
        "enabled": true,
        "conditional": true
      },
      {
        "id": "e_session_prompt",
        "source": "session",
        "target": "prompt",
        "label": "history + summary",
        "enabled": true,
        "conditional": false
      },
      {
        "id": "e_prompt_llm1",
        "source": "prompt",
        "target": "llm_primary",
        "label": "full_prompt",
        "enabled": true,
        "conditional": false
      },
      {
        "id": "e_llm1_gate",
        "source": "llm_primary",
        "target": "rag_gate",
        "label": "route decision",
        "enabled": true,
        "conditional": false
      },
      {
        "id": "e_gate_retriever",
        "source": "rag_gate",
        "target": "retriever",
        "label": "enter RAG branch",
        "enabled": true,
        "conditional": true
      },
      {
        "id": "e_gate_answer",
        "source": "rag_gate",
        "target": "answer_post",
        "label": "direct answer path",
        "enabled": true,
        "conditional": true
      },
      {
        "id": "e_retriever_llm2",
        "source": "retriever",
        "target": "llm_rag",
        "label": "context prompt",
        "enabled": true,
        "conditional": false
      },
      {
        "id": "e_llm2_answer",
        "source": "llm_rag",
        "target": "answer_post",
        "label": "rag answer",
        "enabled": true,
        "conditional": false
      },
      {
        "id": "e_llm2_faq",
        "source": "llm_rag",
        "target": "faq_learn",
        "label": "auto learn",
        "enabled": true,
        "conditional": true
      },
      {
        "id": "e_faq_answer",
        "source": "faq_learn",
        "target": "answer_post",
        "label": "cache update ack",
        "enabled": true,
        "conditional": true
      },
      {
        "id": "e_answer_pose",
        "source": "answer_post",
        "target": "pose",
        "label": "pose inference",
        "enabled": true,
        "conditional": true
      },
      {
        "id": "e_answer_output",
        "source": "answer_post",
        "target": "output",
        "label": "emit directly",
        "enabled": true,
        "conditional": true
      },
      {
        "id": "e_pose_output",
        "source": "pose",
        "target": "output",
        "label": "emit + motion",
        "enabled": true,
        "conditional": false
      }
    ]
  }
}